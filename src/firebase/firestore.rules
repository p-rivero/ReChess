rules_version = '2';

// Unless otherwise specified, top-level documents are publically readable by anyone,
// and only the owner can write to them. The subcollection "private" is only readable
// and writable by the owner.
// If a document contains the field "SERVER", then all writes attempting to modify
// that field will be rejected. This field contains data that can be read by anyone
// with read access to the document, but can only be modified by a server-side function.


//  SCHEMA:
//
//  usernames/{username}: {
//    userId: string
//  }
//
//  users/{userId}: {
//    name?: string
//    about?: string
//    profileImg?: string
//    SERVER: {
//      username: string
//      numWins: boolean
//    }
//    /private/{doc}: {
//      SERVER: {
//        email: string
//        banned: boolean
//        admin: boolean
//      }
//    }
//    /games/{gameId}: {
//      timePlayed: timestamp
//      result: 'win' | 'lose' | 'draw'
//      variantName: string
//      variantId: string
//      opponentName: string
//      opponentId: string
//    }
//  }
//
//  userUpvotes/{userID}: {
//    [variantId]: {
//      timeUpvoted: timestamp
//      variantName: string
//    }
//  }
//
//  variants/{variantId}: {
//    name: string
//    creatorId: string
//    description: string
//    /serverPublic/{doc}: {
//      numUpvotes: number
//    }
//  }

service cloud.firestore {
  match /databases/{database}/documents {
    // Uncomment to allow read/write access on all documents to all users
    // match /{document=**} {
    //   allow read, write;
    // }
    
    match /users/{userId} {
      allow read;
      allow update: if request.auth.uid == userId;
      // Disallow creating and deleting users, they are created and deleted by the server
      allow create: if false;
      allow delete: if false;
      
      // Subcollection with a single document for data that other users cannot read
      match /private/{privateDoc} {
        allow read: if request.auth.uid == userId;
        allow update: if request.auth.uid == userId;
        allow create: if false;
        allow delete: if false;
      }
      
      // Subcollection with a single document for data that the user cannot modify
      // but everyone can read
      match /server/{serverPrivateDoc} {
        allow read;
        allow write: if false;
      }
    }
    
    
    match /variants/{variantId} {
      allow read, write: if request.auth.uid == resource.data.creatorId;
    }
    
  }
}
